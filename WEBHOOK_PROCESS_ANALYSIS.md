# ุชุญููู ููุตู ูุชุฏูู ุนูู ุงูู Webhook ูู ุงููุธุงู

## ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุนูููุฉ
ุนูุฏูุง ูุตู ุทูุจ webhook ุฅูู ุงููุธุงูุ ูุชู ุชูููุฐ ุณูุณูุฉ ูุนูุฏุฉ ูู ุงูุนูููุงุช ุชุดูู ุงูุชุญูู ูู ุงูุจูุงูุงุชุ ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนูุ ูุญูุธ ุงูุจูุงูุงุช. ูุฐุง ุงูุชุญููู ูุดุฑุญ ูู ุฎุทูุฉ ุจุงูุชูุตูู.

## 1. ุงุณุชูุจุงู ุทูุจ ุงูู Webhook
**ุงูููู:** `backend/app/controllers/webhook_controller.py`
**ุงูุฏุงูุฉ:** `webhook()`
**ููุน ุงูุทูุจ:** POST
**ุงููุณุงุฑ:** `/webhook`

### ุงูุนูููุงุช ุงูุชูุตูููุฉ:
- **ุงุณุชูุงู ุงูุจูุงูุงุช:** ูุชู ุงุณุชูุงู JSON payload ูู ูุตุฏุฑ ุฎุงุฑุฌู (ููุตุฉ ุชููููุงุช)
- **ูููู ุงูุจูุงูุงุช ุงููุชููุน:**
  ```json
  {
    "data": {
      "fields": [
        {"label": "email", "value": "customer@email.com"},
        {"label": "shop_id", "value": "123"},
        {"label": "shop_name", "value": "ุงุณู ุงููุชุฌุฑ"},
        {"label": "text", "value": "ูุต ุงูุชูููู"},
        {"label": "stars", "value": 5},
        {"label": "enjoy_most", "value": "ูุง ูุนุฌุจูู"},
        {"label": "improve_product", "value": "ุงูุชุญุณููุงุช"},
        {"label": "additional_feedback", "value": "ููุงุญุธุงุช ุฅุถุงููุฉ"}
      ]
    }
  }
  ```
- **ุฅูุดุงุก DTO:** ูุชู ุฅูุดุงุก ูุงุฆู `ReviewDTO` ูุชุณููู ุงูุชุนุงูู ูุน ุงูุจูุงูุงุช

## 2. ุชุญููู ูุชูุธูู ุงูุจูุงูุงุช
**ุงูููู:** `backend/app/dto/review_dto.py`
**ุงูุฏุงูุฉ:** `ReviewDTO.from_dict()`

### ุงูุนูููุงุช ุงูุชูุตูููุฉ:
- **ุงุณุชุฎุฑุงุฌ ุงูุญููู:** ูุชู ุงุณุชุฎุฑุงุฌ ุงูููู ูู `data.fields[]` ุจุงุณุชุฎุฏุงู dictionary comprehension
- **ุชูุธูู ุงูุจูุงูุงุช:**
  - ุชุญููู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฅูู lowercase
  - ุฅุฒุงูุฉ ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ
  - ุชุญููู ุงูููู ุฅูู ุงูุฃููุงุน ุงูููุงุณุจุฉ (stars โ int)
- **ุงูุชุญูู ุงูุฃููู:** ูุญุต ูุฌูุฏ ุงูุญููู ุงูุฃุณุงุณูุฉ

## 3. ุงูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
**ุงูููู:** `backend/app/services/core/webhook_service.py`
**ุงูุฏุงูุฉ:** `process_review()`

### ุงูุดุฑูุท ุงููุทููุจุฉ:
- `email` - ุบูุฑ ูุงุฑุบ ูุตุงูุญ
- `text` - ูุต ุงูุชูููู ุงูุฃุณุงุณู
- `shop_id` - ูุนุฑู ุงููุชุฌุฑ
- `shop_name` - ุงุณู ุงููุชุฌุฑ

### ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:
```python
if not dto.email or not dto.text or not dto.shop_id or not dto.shop_name:
    raise ValueError("ุงูุญููู ุงููุทููุจุฉ ููููุฏุฉ: ุงูุจุฑูุฏ ุงูุฅููุชุฑูููุ ุงููุตุ ุฑูู ุงููุชุฌุฑุ ุงุณู ุงููุชุฌุฑ")
```

## 4. ุงูุชุญูู ูู ุงููุชุฌุฑ
**ุงูุฏุงูุฉ:** `user_model.find_by_id(dto.shop_id)`

### ุงูุนูููุงุช ุงูุชูุตูููุฉ:
- **ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:** ุงูุจุญุซ ุนู ุงููุชุฌุฑ ุจุงุณุชุฎุฏุงู `shop_id`
- **ูุญุต ุงููุฌูุฏ:** ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุชุฌุฑ
- **ุงูุชุญูู ูู ุงูุงุณู:** ููุงุฑูุฉ `shop_name` ูุน ุงููููุฉ ุงููุญููุธุฉ ูู DB
- **ุญุงูุฉ ุนุฏู ุงูุชุทุงุจู:** ุฑูุน `LookupError` ูุน ุฑุณุงูุฉ "ุงุณู ุงููุชุฌุฑ ุบูุฑ ุตุญูุญ"

## 5. ูุญุต ุงูุชูุฑุงุฑ
**ุงูุฏุงูุฉ:** `review_model.find_existing_review(dto.email, dto.shop_id)`

### ุงูุนูููุงุช ุงูุชูุตูููุฉ:
- **ุงูุจุญุซ ุนู ุงูุชููููุงุช ุงูุณุงุจูุฉ:** ุจุงุณุชุฎุฏุงู ููุณ ุงูุจุฑูุฏ ูุงููุชุฌุฑ
- **ููุน ุงูุชูุฑุงุฑ:** ุฅุฐุง ูุฌุฏ ุชูููู ุณุงุจูุ ูุชู ุฑูุถ ุงูุทูุจ
- **ุงูุฑุณุงูุฉ:** "ููุฏ ููุช ุจุฅุฑุณุงู ุชูููู ููุฐุง ุงููุชุฌุฑ ูุณุจูุงู"

## 6. ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู (ุงููุฑุญูุฉ ุงูุฃูุซุฑ ุชุนููุฏุงู)
**ุงูููู:** `backend/app/services/external/deepseek_service.py`
**ุงูุฏุงูุฉ:** `analyze_review_holistically()`

### 6.1 ุฅุนุฏุงุฏ ุงูุจูุงูุงุช ููุฐูุงุก ุงูุงุตุทูุงุนู
```python
# ุฏูุฌ ุฌููุน ุงููุตูุต
full_text = f"Main Review: {text}\n"
if enjoy_most: full_text += f"Pros: {enjoy_most}\n"
if improve_product: full_text += f"Cons/Improvement: {improve_product}\n"
if additional_feedback: full_text += f"Extra: {additional_feedback}\n"
```

### 6.2 ุจูุงุก Prompt ุงูุฐูุงุก ุงูุงุตุทูุงุนู
ูุชู ุฅุฑุณุงู prompt ููุตู ูุทูุจ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุชุญููู ุงูุชูููู ูุฅุฑุฌุงุน JSON ูุญุฏุฏ ูุญุชูู ุนูู:
- **sentiment:** ุฅูุฌุงุจู/ูุญุงูุฏ/ุณูุจู
- **category:** ุดููู/ุงูุชุฑุงุญ/ูุฏุญ/ุงุณุชูุณุงุฑ/ุนุงู
- **summary:** ููุฎุต ูุตูุฑ
- **key_themes:** ูุงุฆูุฉ ุงูููุงุถูุน ุงูุฑุฆูุณูุฉ
- **actionable_insights:** ุฎุทูุงุช ุชุญุณูู ูุงุจูุฉ ููุชูููุฐ
- **suggested_reply:** ุฑุฏ ููุชุฑุญ ุจุงูุนุฑุจูุฉ
- **quality_score:** 0.0-1.0
- **is_spam:** true/false
- **context_match:** true/false

### 6.3 ุงุณุชุฏุนุงุก ูููุฐุฌ DeepSeek
- **API Call:** `requests.post(API_URL, headers=headers, json=payload)`
- **ุงููุนููุงุช:** model, messages, max_tokens, temperature
- **ุงูุงุณุชุฌุงุจุฉ:** JSON ูุน ุงูุชุญููู ุงููุงูู

### 6.4 ูุนุงูุฌุฉ ุงูุงุณุชุฌุงุจุฉ
- **ุชุญููู JSON:** `json.loads(cleaned_json)`
- **ุชุฑุฌูุฉ ุงููุตุทูุญุงุช:** `_map_sentiment()` ู `_map_category()`
- **ุฅูุดุงุก DTO:** `AnalysisResultDTO.from_dict(data)`

### 6.5 ุงูุชุญูู ุงูุงุฎุชูุงุฑู
- ูุญุต `quality_score < 0.4` ุฃู `is_spam`
- ุชุณุฌูู ุงูุชุญุฐูุฑุงุช ูู ุงูุณุฌูุงุช

## 7. ุจูุงุก ุจูุงูุงุช ุงูุชูููู ุงูููุงุฆูุฉ
**ุงูููู:** `backend/app/services/core/webhook_service.py`
**ุงูุฏุงูุฉ:** `process_review()`

### ูููู ุงูุจูุงูุงุช ุงููุจูู:
```python
review_data = {
    # ุงูุจูุงูุงุช ุงูุนุงููุฉ ุงููุณุชูู
    "email": dto.email,
    "shop_id": dto.shop_id,
    "stars": dto.stars,
    "overall_sentiment": analysis_result.sentiment,
    "category": analysis_result.category,
    "summary": analysis_result.summary,

    # ุงูุจูุงูุงุช ุงูุชูุตูููุฉ
    "organized_feedback": f"๐ ุงูููุฎุต: {analysis_result.summary}\n๐ท๏ธ ุงูููุงุถูุน ุงูุฑุฆูุณูุฉ: {themes_text}",
    "solutions": "\n".join(analysis_result.actionable_insights),
    "suggested_reply": analysis_result.suggested_reply,

    # ุงููุนูููุงุช ุงููุตููุฉ
    "quality_score": analysis_result.quality_score,
    "is_spam": analysis_result.is_spam,
    "context_match": analysis_result.context_match,

    # ุงูุจูุงูุงุช ุงูุฃุตููุฉ
    "original_fields": {
        "text": dto.text,
        "phone": dto.phone,
        "enjoy_most": dto.enjoy_most,
        "improve_product": dto.improve_product,
        "additional_feedback": dto.additional_feedback
    }
}
```

## 8. ุญูุธ ุงูุจูุงูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
**ุงูุฏุงูุฉ:** `review_model.create_review(review_data)`

### ุงูุนูููุงุช:
- **ุฅุฏุฑุงุฌ ูู ุฌุฏูู reviews:** ุญูุธ ุฌููุน ุงูุจูุงูุงุช ุงููุจููุฉ
- **ุฅุฑุฌุงุน ุงููุนุฑู:** `review_id` ููุชูููู ุงูุฌุฏูุฏ
- **ุชุณุฌูู ุงูุนูููุฉ:** `logging.info(f"Review saved: {review_id}")`

## 9. ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ูุตุงุญุจ ุงููุชุฌุฑ
**ุงูุฏุงูุฉ:** `_send_notification(owner, dto, analysis)`

### ุงูุนูููุงุช ุงูุชูุตูููุฉ:
- **ุจูุงุก ุฑุณุงูุฉ ุงูุฅุดุนุงุฑ:**
  ```python
  message = f"ุชูููู ุฌุฏูุฏ: {'โญ' * dto.stars}\n\"{dto.text}\"\nุงูููุน: {analysis.category}"
  ```

- **ุฅุถุงูุฉ ุงูุฑุคู ููุชููููุงุช ุงูุณูุจูุฉ:**
  ```python
  if analysis.sentiment == 'ุณูุจู' or analysis.category in ['ุดููู', 'ููุฏ']:
      if analysis.actionable_insights:
          solutions_text = "\n- ".join(analysis.actionable_insights[:2])
          message += f"\n\n๐ก ูุตูุญุฉ ุณุฑูุนุฉ:\n- {solutions_text}"
  ```

- **ุชุญุฏูุฏ ููุงุฉ ุงูุฅุดุนุงุฑ:**
  - **FCM:** ุฅุฐุง ูุงู `owner.get('device_token')` ููุฌูุฏ
  - **Telegram:** ุฅุฐุง ูุงู `owner.get('telegram_chat_id')` ููุฌูุฏ
  - **ุงูุชุณุฌูู:** ุชุญุฐูุฑ ุฅุฐุง ูู ุชูุฌุฏ ููุงุฉ ุฅุดุนุงุฑ

## 10. ุฅุฑุฌุงุน ุงูุงุณุชุฌุงุจุฉ ุงูููุงุฆูุฉ
**ุงูููู:** `backend/app/utils/response.py`
**ุงูุฏุงูุฉ:** `ResponseBuilder.success()`

### ุงูุงุณุชุฌุงุจุฉ ุงููุงุฌุญุฉ:
```json
{
  "success": true,
  "message": "ุชู ุญูุธ ุงูุชูููู ุจูุฌุงุญ",
  "data": {
    "review_id": "generated_id"
  }
}
```

## ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ูุงูุงุณุชุซูุงุกุงุช

### ุฃููุงุน ุงูุฃุฎุทุงุก:
1. **ValueError (400):** ุญููู ูุทููุจุฉ ููููุฏุฉ
2. **LookupError (400):** ูุชุฌุฑ ุบูุฑ ููุฌูุฏ ุฃู ุงุณู ุบูุฑ ูุทุงุจู ุฃู ุชูููู ููุฑุฑ
3. **Exception (500):** ุฃุฎุทุงุก ุบูุฑ ูุชููุนุฉ

### ุชุณุฌูู ุงูุฃุฎุทุงุก:
- **Validation errors:** `logging.warning(f"Validation error: {e}")`
- **Lookup errors:** `logging.warning(f"Duplicate or not found: {e}")`
- **System errors:** `logging.error(f"Webhook error: {e}", exc_info=True)`

## ุชุญููู ุงูุฃุฏุงุก ูุงูุฃูุงู

### ุงูุฃูุงู:
- **ูุญุต ุงูุชูุฑุงุฑ:** ููุน ุงูุฅุฑุณุงู ุงูููุฑุฑ
- **ุงูุชุญูู ูู ุงูุจูุงูุงุช:** ุชูุธูู ููุญุต ุตุญุฉ ุงููุฏุฎูุงุช
- **ูุญุต ุงูุณุจุงู:** ูุดู ุงููุญุชูู ุบูุฑ ุงููุฑุบูุจ

### ุงูุฃุฏุงุก:
- **ูุนุงูุฌุฉ ูุงุญุฏุฉ ููุฐูุงุก ุงูุงุตุทูุงุนู:** ุชุญููู ุดุงูู ูู ููุงููุฉ ูุงุญุฏุฉ
- **ุชุฎุฒูู ูุคูุช ูุญุชูู:** ูููุชุงุฌุฑ ูุงููุณุชุฎุฏููู ุงููุชูุฑุฑูู
- **ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก:** ุนุฏู ุชููู ุงููุธุงู ุนูุฏ ูุดู ูููู ูุงุญุฏ

### ูุงุจููุฉ ุงูุชูุณุน:
- **ุฎุฏูุงุช ูููุตูุฉ:** ูุตู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุนู ุงูููุทู ุงูุฃุณุงุณู
- **ููุงุนุฏ ุจูุงูุงุช ูุงุจูุฉ ูููุณูุฉ:** ุฅููุงููุฉ ุชูุฒูุน ุงูุจูุงูุงุช
- **ุฅุดุนุงุฑุงุช ูุชุนุฏุฏุฉ ุงููููุงุช:** ุฏุนู FCM ู Telegram ููููุงุช ุฃุฎุฑู

## ุงูุฎูุงุตุฉ
ูุฐุง ุงูุชุฏูู ูุถูู ูุนุงูุฌุฉ ุดุงููุฉ ูุฐููุฉ ููุชููููุงุช ุงููุงุฑุฏุฉ ุนุจุฑ webhookุ ูุน ุงูุชุฑููุฒ ุนูู ุฌูุฏุฉ ุงูุชุญููู ูุงูุฃูุงู ูุงูุฃุฏุงุก. ูู ุฎุทูุฉ ูุตููุฉ ูุถูุงู ุณูุงูุฉ ุงูุจูุงูุงุช ูุชูุฏูู ุฑุคู ูููุฉ ูุฃุตุญุงุจ ุงููุชุงุฌุฑ.
