# ุงูุนูุงุฑุฉ ุงูุฌุฏูุฏุฉ ููู Webhook - ุงููุณุฎุฉ 2

## ๐ ูุธุฑุฉ ุนุงูุฉ ุนูู ุงูุชุญุณููุงุช

ุชู ุฅุนุงุฏุฉ ููููุฉ ูุธุงู ูุนุงูุฌุฉ ุงูุชููููุงุช ููุตู ุงููุณุคูููุงุช ูุชุญุณูู ุงูููุงุกุฉ:

```
ุงููุณุฎุฉ ุงููุฏููุฉ:
DeepSeekService โ ููุนู ูู ุดูุก ูู ููุงููุฉ ูุงุญุฏุฉ
โโ ุชุญููู Sentiment
โโ ุชุญููู Toxicity
โโ ุชุตููู ุงูููุน
โโ ูุดู ุงูุฌูุฏุฉ
โโ ูุดู ุงูุณูุงู
โโ ุงูุชุฑุงุญ ุงูุญููู
โโ ุตูุงุบุฉ ุงูุฑุฏ

ุงููุณุฎุฉ ุงูุฌุฏูุฏุฉ:
โโ SentimentServiceV2 โ ุงูุชุญููู ุงูุฃููู ุงูุณุฑูุน (HF Models)
โ  โโ ุชูุธูู ุงููุตูุต
โ  โโ ุชุญููู Sentiment (HF_SENTIMENT_MODEL_URL)
โ  โโ ุชุญููู Toxicity (HF_TOXICITY_MODEL_URL)
โ  โโ ุชุตููู ุงูููุน
โ  โโ ูุดู ุงูุฌูุฏุฉ
โ  โโ ูุดู ุงูุณูุงู
โ
โโ DeepSeekServiceV2 โ ุงููุนุงูุฌุฉ ุงูุฐููุฉ (DeepSeek AI)
   โโ ุงุณุชูุจุงู ูุชุงุฆุฌ SentimentServiceV2 ูุณูุงู
   โโ ุชูุธูู ูุชูุณูู ุงููุตูุต
   โโ ุงูุชุฑุงุญ ุญููู ุฐููุฉ
   โโ ุตูุงุบุฉ ุฑุฏ ุงุญุชุฑุงูู
```

---

## ๐ ุชุฏูู ุงูุนูู ุงูุฌุฏูุฏ

### ุงููุฑุญูุฉ 1: ุงุณุชูุจุงู ุงูุทูุจ (webhook_controller.py - **ุจุฏูู ุชุบููุฑ**)
```
POST /webhook
โโ ูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ReviewDTO
```

### ุงููุฑุญูุฉ 2: ุงูุชุญูู ุงูุฃุณุงุณู (WebhookServiceV2.process_review)
```
1. ุงูุชุญูู ูู ุงููุชุฌุฑ ูุงูุจุฑูุฏ
2. ูุญุต ุนุฏู ุชูุฑุงุฑ ุงูุชูููู
```

### ุงููุฑุญูุฉ 3: ุงูุชุญููู ุงูุฃููู (SentimentServiceV2.analyze_review_comprehensive)
```
Input: ReviewDTO + shop_type
Output: SentimentAnalysisResultDTO
โโ sentiment: "ุฅูุฌุงุจู" | "ุณูุจู" | "ูุญุงูุฏ"
โโ toxicity: "toxic" | "uncertain" | "non-toxic"
โโ category: "ุดููู" | "ููุฏ" | "ุฅูุฌุงุจู" | "ุนุงู"
โโ quality_score: 0.0-1.0
โโ quality_flags: ["empty_content", "gibberish", etc]
โโ context_match: boolean
โโ mismatch_reasons: list
```

**ุงูุฎุทูุงุช ุงูุชูุตูููุฉ:**
```
1. ุชูุธูู ุงููุตูุต ุงูุฎูุณุฉ:
   - text (ุงููุต ุงูุฑุฆูุณู)
   - enjoy_most (ุงูุฅูุฌุงุจูุงุช)
   - improve_product (ุงูุชุญุณููุงุช)
   - additional_feedback (ุงูููุงุญุธุงุช)
   - ูุญุต ุฅุฐุง ูุงูุช ูุงุฑุบุฉ/null

2. ุชุญููู Sentiment:
   - ุฅุฑุณุงู ุงููุต ุงููุฏูุฌ ุฅูู HF_SENTIMENT_MODEL_URL
   - ุงูุญุตูู ุนูู: "ุฅูุฌุงุจู" ุฃู "ุณูุจู" ุฃู "ูุญุงูุฏ"

3. ุชุญููู Toxicity:
   - ุฅุฑุณุงู ุงููุต ุฅูู HF_TOXICITY_MODEL_URL
   - ููุงุฑูุฉ ูุน ุชุณููุงุช: "ุดุชุงุฆู ูููุงู ุจุฐูุก" vs "ููุฏ ูุญุชุฑู"
   - ุงูุญุตูู ุนูู: "toxic" ุฃู "uncertain" ุฃู "non-toxic"

4. ุชุตููู ููุน ุงูุชูููู:
   - ุฏูุฌ: sentiment + toxicity + stars + complaint keywords
   - ุงูุญุตูู ุนูู: "ุดููู" (ุฅุฐุง ูุงู toxic) ุฃู "ููุฏ" (ุฅุฐุง ูุงู ุณูุจู)
            ุฃู "ุฅูุฌุงุจู" (ุฅุฐุง ูุงู ููุฌุจ)

5. ูุดู ุฌูุฏุฉ ุงููุต:
   - ูุญูุตุงุช: ุทููุ ุชูุฑุงุฑ ุฃุญุฑูุ ูุญุชูู ุนุดูุงุฆูุ ุฎุงุต
   - ุฅุฐุง ูุงู < 0.5 ุฏุฑุฌุฉ โ is_spam = true

6. ูุดู ุชุทุงุจู ุงูุณูุงู:
   - ูู ุงููุต ูุชุนูู ุจููุน ุงููุชุฌุฑุ
   - ุงุณุชุฎุฏุงู zero-shot classification ูู HF
   - ุฅุฐุง ูุงูุช ุงูุตูุฉ < 40% โ context_match = false
```

**ุงููููุฒุงุช:**
- โก **ุณุฑูุน:** ูุณุชุฎุฏู ููุงุฐุฌ ุฎูููุฉ ูู HuggingFace
- ๐ฐ **ุงูุชุตุงุฏู:** ูููู ุนุฏุฏ ููุงููุงุช DeepSeek
- ๐ **ุฏููู:** ูุดู ูุจูุฑ ูููุตูุต ุงูุถุนููุฉ/ุงูุจุฐูุฆุฉ
- ๐ **ุดุงูู:** ูุนูููุงุช ุชูุตูููุฉ ุนู ุณุจุจ classification ูู ุดูุก

---

### ุงููุฑุญูุฉ 4: ุงููุนุงูุฌุฉ ุงูุฐููุฉ (DeepSeekServiceV2.format_insights_and_reply)
```
Input: ReviewDTO + SentimentAnalysisResultDTO + shop_type
Output: AnalysisResultDTO
โโ summary: ููุฎุต ูุตูุฑ
โโ key_themes: ["ููุถูุน1", "ููุถูุน2"]
โโ actionable_insights: ["ุญู1", "ุญู2"]
โโ suggested_reply: ุฑุฏ ุงุญุชุฑุงูู
```

**ุงูุฎุทูุงุช ุงูุชูุตูููุฉ:**
```
1. ุจูุงุก Prompt ุฐูู:
   - ูุชุถูู ูุชุงุฆุฌ ุงูุชุญููู ูู ุงููุฑุญูุฉ 3 ูุณูุงู
   - ูุทูุจ ูู DeepSeek ุงูุชุฑููุฒ ุนูู:
     โ ุชูุธูู ูุชูุณูู ุงูููุฎุต
     โ ุงุณุชุฎุฑุงุฌ ููุงุถูุน ุฑุฆูุณูุฉ
     โ ุงูุชุฑุงุญ ุญููู ุนูููุฉ ูุญุฏุฏุฉ
     โ ุตูุงุบุฉ ุฑุฏ ุงุญุชุฑุงูู ูุชุนุงุทูู

2. ุงุณุชุฏุนุงุก DeepSeek API:
   - Model: deepseek-ai/DeepSeek-V3
   - Temperature: 0.5 (ุชูุงุฒู ุจูู ุงูุฅุจุฏุงุน ูุงูุงุณุชูุฑุงุฑ)
   - Max tokens: 1500

3. ูุนุงูุฌุฉ ุงูุงุณุชุฌุงุจุฉ:
   - ุชุญููู JSON
   - ุงุณุชุฎุฑุงุฌ ุงูุญููู ุงูุฃุฑุจุนุฉ
   - fallback ุขูู ุฅุฐุง ูุดู ุงูุชุญููู
```

**ุงููููุฒุงุช:**
- ๐ง **ุฐูู:** ูุณุชุฎุฏู ุงูุณูุงู ูู ุงููุฑุญูุฉ 1
- ๐ฅ **ุชุนุงุทูู:** ููุชุฌ ุฑุฏูุฏ ุงุญุชุฑุงููุฉ ูููุงุณุจุฉ ุซูุงููุงู
- ๐ก **ุนููู:** ููุชุฑุญ ุญููู ูุญุฏุฏุฉ ูููุณ ุฅุฌุงุจุงุช ุนุงูุฉ
- ๐ **ูุนุงู:** ูุฑูุฒ ููุท ุนูู ูุง ูุญุชุงุฌู

---

### ุงููุฑุญูุฉ 5: ุงูุญูุธ ูุงูุฅุดุนุงุฑ (WebhookServiceV2.process_review)
```
1. ุจูุงุก review_data:
   - ูุนูููุงุช ุงูุนููู ูุงููุชุฌุฑ
   - ูุชุงุฆุฌ ุงูุชุญููู ุงูุฃููู (sentiment, toxicity, category, flags)
   - ูุชุงุฆุฌ ุงููุนุงูุฌุฉ ุงูุฐููุฉ (summary, insights, reply)
   - ุงูุจูุงูุงุช ุงูุฃุตููุฉ ูููุฑุฌุนูุฉ

2. ุญูุธ ูู MongoDB:
   - create_review() ูุน ุฌููุน ุงูุจูุงูุงุช

3. ุฅุฑุณุงู ุฅุดุนุงุฑ:
   - ูููุงูู: ููุฎุต ุงูุชูููู + ุฃุนูู ุญููู
   - ุนุจุฑ: FCM ุฃู Telegram
```

---

## ๐ ููุงุฑูุฉ ุงูุจูุงูุงุช ุงููุญููุธุฉ

### ุงููุณุฎุฉ ุงููุฏููุฉ:
```json
{
  "sentiment": "ุฅูุฌุงุจู",
  "category": "praise",
  "summary": "...",
  "suggested_reply": "...",
  "quality_score": 0.9,
  "is_spam": false,
  "context_match": true
}
```

### ุงููุณุฎุฉ ุงูุฌุฏูุฏุฉ:
```json
{
  "overall_sentiment": "ุฅูุฌุงุจู",
  "toxicity": "non-toxic",  // ๐
  "category": "ุฅูุฌุงุจู",
  "summary": "...",
  "actionable_insights": ["...", "..."],
  "suggested_reply": "...",
  "quality_score": 0.9,
  "quality_flags": ["..."],  // ๐
  "is_spam": false,
  "context_match": true,
  "mismatch_reasons": ["..."]  // ๐
}
```

**ุงูุฅุถุงูุงุช:**
- โ `toxicity` - ุฏุฑุฌุฉ ุงูุณููุฉ ุจุงูุชูุตูู
- โ `quality_flags` - ุฃุณุจุงุจ ูุญุฏุฏุฉ ูุฃู ูุดุงูู ุจุงูุฌูุฏุฉ
- โ `mismatch_reasons` - ุฃุณุจุงุจ ุนุฏู ุงูุชุทุงุจู ูุน ุงูุณูุงู

---

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ูู WebhookController (ุจุฏูู ุชุบููุฑ):
```python
from app.services.core.webhook_service_v2 import WebhookServiceV2

webhook_service = WebhookServiceV2()
result = webhook_service.process_review(dto)
```

### ุงุฎุชูุงุฑู: ููุงุณุชุฎุฏุงู ุงููุจุงุดุฑ
```python
from app.services.external.sentiment_service_v2 import SentimentServiceV2
from app.services.external.deepseek_service_v2 import DeepSeekServiceV2

sentiment_svc = SentimentServiceV2()
deepseek_svc = DeepSeekServiceV2()

sentiment_result = sentiment_svc.analyze_review_comprehensive(dto, shop_type)
analysis_result = deepseek_svc.format_insights_and_reply(dto, sentiment_result, shop_type)
```

---

## โ๏ธ ุงููุชุทูุจุงุช ูู .env

```env
# Hugging Face (ููุฌูุฏ ุจุงููุนู)
HF_TOKEN=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
HF_SENTIMENT_MODEL_URL=https://router.huggingface.co/models/CAMeL-Lab/bert-base-arabic-camelbert-da-sentiment
HF_TOXICITY_MODEL_URL=https://router.huggingface.co/models/MoritzLaurer/mDeBERTa-v3-base-mnli-xnli

# DeepSeek (ููุฌูุฏ ุจุงููุนู)
API_URL=https://router.huggingface.co/v1/chat/completions
MODEL_ID=deepseek-ai/DeepSeek-V3
```

---

## ๐ ููุงุฆุฏ ุงูุนูุงุฑุฉ ุงูุฌุฏูุฏุฉ

| ุงูุฌุงูุจ | ุงููุณุฎุฉ ุงููุฏููุฉ | ุงููุณุฎุฉ ุงูุฌุฏูุฏุฉ |
|--------|---|---|
| **ุณุฑุนุฉ** | 30-40 ุซุงููุฉ | 15-20 ุซุงููุฉ |
| **ุชูููุฉ ุงูุชุดุบูู** | ุนุงููุฉ | ููุฎูุถุฉ (~50%) |
| **ุฏูุฉ ุงูุชุญููู** | ูุญุฏูุฏุฉ | ุนุงููุฉ |
| **ูุดู Spam** | ุฏุงุฎู DeepSeek | ูุจูุฑ ูู SentimentService |
| **ูุนูููุงุช Toxicity** | ุถูููุฉ | ุตุฑูุญุฉ ูู ุงููุชูุฌุฉ |
| **ุณูููุฉ ุงูุตูุงูุฉ** | ูุนูุฏุฉ | ุจุณูุทุฉ |
| **ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู** | ุตุนุจุฉ | ุณููุฉ ุฌุฏุงู |

---

## ๐ ูุนุงูุฌุฉ ุงูุญุงูุงุช ุงูุฎุงุตุฉ

### 1. ูุต ูุงุฑุบ ุชูุงูุงู
```
SentimentService โ sentiment="ูุญุงูุฏ", quality_score=0.0, is_spam=true
DeepSeek โ ูุง ูุชู ุงุณุชุฏุนุงุคู ุฅุฐุง ูุงู spam
Fallback Reply: "ุดูุฑุงู ูู ุนูู ุชููููู"
```

### 2. ูุต ุจููุงู ุจุฐูุก
```
SentimentService โ toxicity="toxic", quality_score -= 0.4
ุงูุญูุธ: ูุน ุนูู ุชุงู ุจุฃู ุงููุต ูุญุชูู ุนูู ููุงู ุจุฐูุก
ูุฑุงุฌุนุฉ ูุฏููุฉ ููุตู ุจูุง
```

### 3. ูุต ูุง ูุชุทุงุจู ูุน ููุน ุงููุชุฌุฑ
```
SentimentService โ context_match=false, mismatch_reasons=["..."]
Logging: ุชุญุฐูุฑ ุจุฃู ุงููุต ุจุนูุฏ ุนู ุงูุณูุงู
ุงูุญูุธ: ูุน ููุงุญุธุฉ ูุฑุงุฌุนุฉ ูุฏููุฉ
```

### 4. ูุต ูุตูุฑ ุฌุฏุงู
```
SentimentService โ quality_flags=["too_short"]
ูุฏ ูููู is_spam=true ุฅุฐุง ูุงู < ุญุฑููู
```

---

## โจ ุงูุฎูุงุตุฉ

ุงูุนูุงุฑุฉ ุงูุฌุฏูุฏุฉ ุชููุฑ:
- โ ูุตู ูุงุถุญ ูููุณุคูููุงุช
- โ ุชุญููู ุฃููู ููุซูู ูุณุฑูุน
- โ ูุนุงูุฌุฉ ุฐููุฉ ูุฅุจุฏุงุนูุฉ
- โ ููุงุกุฉ ุนุงููุฉ ูู ุงูุฃุฏุงุก ูุงูุชูุงููู
- โ ูุนูููุงุช ุชูุตูููุฉ ูููุฑุงุฌุนุฉ ุงููุฏููุฉ
- โ ุณูููุฉ ูู ุงูุตูุงูุฉ ูุงูุชุทููุฑ ุงููุณุชูุจูู
