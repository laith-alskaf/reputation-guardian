═══════════════════════════════════════════════════════════════════════════════
                      مقارنة بصرية: النسخة القديمة vs الجديدة
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                          النسخة القديمة (OLD)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   webhook_controller.py                                                    │
│        │                                                                   │
│        ├─► webhook_service.py                                              │
│             │                                                              │
│             ├─► review_model.find_existing_review()                        │
│             │                                                              │
│             └─► deepseek_service.analyze_review_holistically()             │
│                  │                                                         │
│                  ├─► HF Query: Build comprehensive prompt                  │
│                  │   [معالجة كل شيء في prompt واحد]                       │
│                  │                                                         │
│                  └─► LLM Response                                          │
│                      {                                                     │
│                        sentiment: تحليل LLM فقط                           │
│                        category: تحليل LLM فقط                            │
│                        summary: تحليل LLM فقط                             │
│                        themes: تحليل LLM فقط                              │
│                        insights: تحليل LLM فقط                            │
│                        reply: تحليل LLM فقط                               │
│                        quality_score: تحليل LLM فقط                       │
│                        spam/context: تحليل LLM فقط                        │
│                      }                                                     │
│                  ⏱️  30-40 ثانية | 💰 ~2000 tokens                        │
│                  ❌ بطيء | ❌ غالي | ❌ معلومات Toxicity ضمنية            │
│                                                                             │
│             ├─► review_model.create_review()                               │
│             │                                                              │
│             └─► notification_service.send()                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          النسخة الجديدة (NEW)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   webhook_controller.py                                                    │
│        │                                                                   │
│        ├─► webhook_service_v2.py                                            │
│             │                                                              │
│             ├─► review_model.find_existing_review()                        │
│             │                                                              │
│             │ ╔════════════════════════════════════════════════════════╗  │
│             │ ║  المرحلة 1: التحليل الأولي السريع (7-12 ثانية)        ║  │
│             │ ╠════════════════════════════════════════════════════════╣  │
│             └─► sentiment_service_v2.analyze_review_comprehensive()        │
│                  │                                                         │
│                  ├─► clean_text()                                          │
│                  │   [تنظيف النصوص من أحرف خاصة]                        │
│                  │                                                         │
│                  ├─► analyze_sentiment()                                   │
│                  │   HF API Call: HF_SENTIMENT_MODEL_URL                   │
│                  │   Result: "إيجابي" | "سلبي" | "محايد"                  │
│                  │   ⏱️  2-3 ثانية | 💰 ~50 tokens                       │
│                  │                                                         │
│                  ├─► analyze_toxicity()                                    │
│                  │   HF API Call: HF_TOXICITY_MODEL_URL                    │
│                  │   Result: "toxic" | "uncertain" | "non-toxic"           │
│                  │   ⏱️  2-3 ثانية | 💰 ~50 tokens                       │
│                  │                                                         │
│                  ├─► classify_review()                                     │
│                  │   Logic: sentiment + toxicity + stars + keywords        │
│                  │   Result: "شكوى" | "نقد" | "إيجابي"                     │
│                  │   ⏱️  < 100ms | 💰 0 tokens                            │
│                  │                                                         │
│                  ├─► detect_review_quality()                               │
│                  │   Checks:                                               │
│                  │   - طول النص                                           │
│                  │   - تكرار الأحرف                                        │
│                  │   - محتوى عشوائي                                        │
│                  │   - أحرف خاصة                                           │
│                  │   - toxicity score                                      │
│                  │   Result: quality_score, flags, is_spam                 │
│                  │   ⏱️  < 200ms | 💰 0 tokens                            │
│                  │                                                         │
│                  └─► detect_context_mismatch()                             │
│                      HF Zero-Shot Classification                           │
│                      Compares: text vs shop_type                           │
│                      Result: context_match, reasons                        │
│                      ⏱️  3-5 ثانية | 💰 ~100 tokens                      │
│                  ✅ Output: SentimentAnalysisResultDTO                    │
│                     {                                                      │
│                       sentiment: "إيجابي",                                 │
│                       toxicity: "non-toxic",        ⭐ جديد!              │
│                       category: "إيجابي",                                 │
│                       quality_score: 0.95,                                │
│                       quality_flags: [],           ⭐ جديد!              │
│                       is_spam: false,                                     │
│                       context_match: true,                                │
│                       mismatch_reasons: []         ⭐ جديد!              │
│                     }                                                      │
│             │                                                              │
│             │ [اختبار للجودة والسياق]                                     │
│             │ if quality_score < 0.4 or is_spam → تحذير                   │
│             │ if not context_match → تحذير                                │
│             │                                                              │
│             │ ╔════════════════════════════════════════════════════════╗  │
│             │ ║  المرحلة 2: المعالجة الذكية (8-15 ثانية)              ║  │
│             │ ║  [فقط إذا لم تكن is_spam = true]                     ║  │
│             │ ╠════════════════════════════════════════════════════════╣  │
│             └─► deepseek_service_v2.format_insights_and_reply()            │
│                  │                                                         │
│                  ├─► بناء Prompt ذكي:                                      │
│                  │   "أنت خبير في تحليل التقييمات..."                    │
│                  │   [يتضمن نتائج المرحلة 1 كسياق]                       │
│                  │   "sentiment من النظام: إيجابي"                        │
│                  │   "toxicity من النظام: non-toxic"                      │
│                  │   "category من النظام: إيجابي"                         │
│                  │                                                         │
│                  └─► LLM Response (Focused & Efficient)                    │
│                      {                                                     │
│                        summary: تنسيق وملخص قصير                          │
│                        key_themes: استخراج 2-4 مواضيع                     │
│                        actionable_insights: 2-3 حلول محددة                │
│                        suggested_reply: رد احترافي وتعاطفي               │
│                      }                                                     │
│                  ⏱️  8-15 ثانية | 💰 ~500 tokens                         │
│                  ✅ Output: AnalysisResultDTO                             │
│             │                                                              │
│             ├─► review_model.create_review()                               │
│             │   [يحتوي على بيانات من المرحلة 1 + المرحلة 2]             │
│             │                                                              │
│             └─► notification_service.send()                                │
│                                                                             │
│   ✅ الإجمالي: 15-27 ثانية | 💰 ~700 tokens                              │
│   ✅ سريع جداً | ✅ اقتصادي | ✅ معلومات شاملة                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
                             مقارنة الأداء
═══════════════════════════════════════════════════════════════════════════════

النسخة القديمة:
┌─────────────┐
│ DeepSeek ▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪ 30-40s
└─────────────┘

النسخة الجديدة:
┌──────────────┐
│ Phase 1 ▪▪▪▪▪▪▪▪ 7-12s  (HF Models)
└──────────────┘
┌──────────────┐
│ Phase 2 ▪▪▪▪▪▪▪▪▪▪▪▪▪ 8-15s  (DeepSeek)
└──────────────┘
الإجمالي: ▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪▪ 15-27s (-50%)

═══════════════════════════════════════════════════════════════════════════════
                             مقارنة التكلفة
═══════════════════════════════════════════════════════════════════════════════

النسخة القديمة:
┌─────────────┐
│ DeepSeek ████████████████████ ~2000 tokens
└─────────────┘

النسخة الجديدة:
┌──────────────┐
│ Phase 1 ██ ~200 tokens     (HF رخيص جداً)
└──────────────┘
┌──────────────┐
│ Phase 2 ████████ ~500 tokens (DeepSeek)
└──────────────┘
الإجمالي: ██████████ ~700 tokens (-65%)

═══════════════════════════════════════════════════════════════════════════════
                         مقارنة المعلومات المُرجعة
═══════════════════════════════════════════════════════════════════════════════

النسخة القديمة:
  ├─ sentiment ........................... ✓ (من LLM)
  ├─ category ........................... ✓ (من LLM)
  ├─ summary ............................ ✓ (من LLM)
  ├─ key_themes ......................... ✓ (من LLM)
  ├─ actionable_insights ................ ✓ (من LLM)
  ├─ suggested_reply .................... ✓ (من LLM)
  ├─ quality_score ...................... ✓ (من LLM)
  ├─ is_spam ............................ ✓ (من LLM)
  ├─ context_match ...................... ✓ (من LLM)
  ├─ toxicity ........................... ✗ (غير متاح)
  ├─ quality_flags ...................... ✗ (غير متاح)
  └─ mismatch_reasons ................... ✗ (غير متاح)

النسخة الجديدة:
  ├─ sentiment ........................... ✓ (من HF + LLM)
  ├─ category ........................... ✓ (من HF + LLM)
  ├─ summary ............................ ✓ (من LLM)
  ├─ key_themes ......................... ✓ (من LLM)
  ├─ actionable_insights ................ ✓ (من LLM)
  ├─ suggested_reply .................... ✓ (من LLM)
  ├─ quality_score ...................... ✓ (من HF analysis)
  ├─ is_spam ............................ ✓ (من HF + Logic)
  ├─ context_match ...................... ✓ (من HF zero-shot)
  ├─ toxicity ........................... ✓ (من HF) ⭐ جديد!
  ├─ quality_flags ...................... ✓ (من HF) ⭐ جديد!
  └─ mismatch_reasons ................... ✓ (من HF) ⭐ جديد!

═══════════════════════════════════════════════════════════════════════════════
                        مثال عملي: تدفق البيانات
═══════════════════════════════════════════════════════════════════════════════

Input:
{
  "email": "customer@example.com",
  "shop_id": "shop123",
  "stars": 5,
  "text": "الخدمة والجودة رائعة جداً",
  "enjoy_most": "الموظفون لطيفون جداً",
  "improve_product": "يمكن تحسين الأسعار قليلاً",
  "additional_feedback": "سأعود قريباً بكل تأكيد"
}

         ↓ [المرحلة 1: SentimentServiceV2]

SentimentAnalysisResultDTO:
{
  "sentiment": "إيجابي",
  "toxicity": "non-toxic",
  "category": "إيجابي",
  "quality_score": 0.92,
  "is_spam": false,
  "context_match": true,
  "quality_flags": [],
  "mismatch_reasons": []
}

         ↓ [المرحلة 2: DeepSeekServiceV2]

AnalysisResultDTO:
{
  "sentiment": "إيجابي",
  "category": "إيجابي",
  "summary": "العميل راضي جداً عن الخدمة والموظفين",
  "key_themes": ["الخدمة", "الموظفون", "الجودة"],
  "actionable_insights": [
    "الاستمرار في نفس مستوى الخدمة المتميزة",
    "تدريب الموظفين على الحفاظ على اللطف والكفاءة",
    "مراجعة سياسة الأسعار للمنتجات الشهيرة"
  ],
  "suggested_reply": "شكراً جزيلاً على تقييمك الرائع! نحن فخورون بأن يكون موظفونا اللطفاء قد قدموا خدمة متميزة..."
}

         ↓ [في قاعدة البيانات]

review_data:
{
  "email": "customer@example.com",
  "shop_id": "shop123",
  "stars": 5,
  
  // من المرحلة 1
  "overall_sentiment": "إيجابي",
  "toxicity": "non-toxic",
  "category": "إيجابي",
  "quality_score": 0.92,
  "quality_flags": [],
  "is_spam": false,
  "context_match": true,
  "mismatch_reasons": [],
  
  // من المرحلة 2
  "summary": "العميل راضي جداً عن الخدمة والموظفين",
  "organized_feedback": "📝 الملخص: العميل راضي...\n🏷️ المواضيع: الخدمة - الموظفون - الجودة",
  "solutions": "- الاستمرار في نفس المستوى\n- تدريب الموظفين\n- مراجعة الأسعار",
  "suggested_reply": "شكراً جزيلاً...",
  
  // البيانات الأصلية
  "original_fields": { ... }
}

═══════════════════════════════════════════════════════════════════════════════
                           الخلاصة بسرعة
═══════════════════════════════════════════════════════════════════════════════

القديم:
  ❌ بطيء (30-40s)
  ❌ غالي (2000 tokens)
  ❌ معلومات Toxicity ضمنية
  ❌ كل شيء في مكالمة واحدة معقدة

الجديد:
  ✅ سريع (15-27s)
  ✅ اقتصادي (700 tokens)
  ✅ معلومات شاملة وصريحة
  ✅ فصل واضح للمسؤوليات
  ✅ أفضل في كشف Spam والنصوص الرديئة

═══════════════════════════════════════════════════════════════════════════════
